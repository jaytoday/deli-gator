#!/bin/bash
# wiki-list-space - List pages in a Confluence space
# Usage: wiki-list-space SPACE_KEY [--limit N]


# Load credentials from environment or secure storage
load_credentials() {
    # Try environment variables first
    if [[ -n "$CONFLUENCE_API_TOKEN" ]]; then
        TOKEN="$CONFLUENCE_API_TOKEN"
        return 0
    fi

    # Try 1Password (if available)
    if command -v op &> /dev/null; then
        TOKEN=$(op read "op://Private/CONFLUENCE API/credential" 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    # Try Keybase (if available)
    if command -v keybase &> /dev/null; then
        TOKEN=$(keybase fs read /keybase/private/$(keybase whoami)/confluence-token 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    echo "Error: Credentials not found. Set CONFLUENCE_API_TOKEN environment variable." >&2
    exit 1
}

# Load credentials
load_credentials

set -e

BASE_URL="https://example.atlassian.net/wiki"

SPACE_KEY="$1"
LIMIT="${3:-50}"  # Default limit 50

if [[ "$2" == "--limit" ]] && [[ -n "$3" ]]; then
    LIMIT="$3"
fi

if [[ -z "$SPACE_KEY" ]]; then
    echo "Usage: wiki-list-space SPACE_KEY [--limit N]"
    echo ""
    echo "List pages in a Confluence space"
    echo ""
    echo "Examples:"
    echo "  wiki-list-space OPS"
    echo "  wiki-list-space OPS --limit 100"
    echo ""
    echo "Common spaces:"
    echo "  OPS - DevOPS space"
    exit 1
fi

AUTH_HEADER=$(echo -n "user@example.com:$TOKEN" | openssl base64 -A)

echo "Listing pages in space: $SPACE_KEY (limit: $LIMIT)" >&2

# List pages
RESPONSE=$(curl --http1.1 -s -X GET \
  -H "Authorization: Basic $AUTH_HEADER" \
  "$BASE_URL/rest/api/space/$SPACE_KEY/content?limit=$LIMIT")

# Check for errors
if echo "$RESPONSE" | jq -e '.message' >/dev/null 2>&1; then
    echo "Error: $(echo "$RESPONSE" | jq -r '.message')" >&2
    exit 1
fi

# Format results
echo "$RESPONSE" | jq -r '.page.results[] | {
    id: .id,
    title: .title,
    url: (.["_links"].base + .["_links"].webui)
}'
