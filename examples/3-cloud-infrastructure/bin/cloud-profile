#!/bin/bash
# Switch AWS profile or show current
# Usage: cloud-profile [PROFILE_NAME]


# Load credentials from environment or secure storage
load_credentials() {
    # Try environment variables first
    if [[ -n "$AWS_API_TOKEN" ]]; then
        TOKEN="$AWS_API_TOKEN"
        return 0
    fi

    # Try 1Password (if available)
    if command -v op &> /dev/null; then
        TOKEN=$(op read "op://Private/AWS API/credential" 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    # Try Keybase (if available)
    if command -v keybase &> /dev/null; then
        TOKEN=$(keybase fs read /keybase/private/$(keybase whoami)/aws-token 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    echo "Error: Credentials not found. Set AWS_API_TOKEN environment variable." >&2
    exit 1
}

# Load credentials
load_credentials

if [ $# -eq 0 ]; then
  # Show current profile
  CURRENT="${AWS_PROFILE:-default}"
  echo "Current profile: $CURRENT"
  echo ""
  echo "Available profiles:"
  aws configure list-profiles | while read p; do
    if [ "$p" = "$CURRENT" ]; then
      echo "  * $p (active)"
    else
      echo "    $p"
    fi
  done
else
  # Switch profile
  PROFILE="$1"
  # Verify profile exists
  if aws configure list-profiles | grep -q "^${PROFILE}$"; then
    export AWS_PROFILE="$PROFILE"
    echo "Switched to profile: $PROFILE"
    echo "Run: export AWS_PROFILE=$PROFILE"
  else
    echo "Error: Profile '$PROFILE' not found"
    exit 1
  fi
fi
