#!/bin/bash
# List IAM access keys for user
# Usage: cloud-iam-keys USERNAME [--profile PROFILE]


# Load credentials from environment or secure storage
load_credentials() {
    # Try environment variables first
    if [[ -n "$AWS_API_TOKEN" ]]; then
        TOKEN="$AWS_API_TOKEN"
        return 0
    fi

    # Try 1Password (if available)
    if command -v op &> /dev/null; then
        TOKEN=$(op read "op://Private/AWS API/credential" 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    # Try Keybase (if available)
    if command -v keybase &> /dev/null; then
        TOKEN=$(keybase fs read /keybase/private/$(keybase whoami)/aws-token 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    echo "Error: Credentials not found. Set AWS_API_TOKEN environment variable." >&2
    exit 1
}

# Load credentials
load_credentials

set -euo pipefail

PROFILE="${AWS_PROFILE:-default}"

if [ $# -eq 0 ]; then
  echo "Usage: cloud-iam-keys USERNAME [--profile PROFILE]"
  exit 1
fi

USERNAME="$1"
shift

while [[ $# -gt 0 ]]; do
  case "$1" in
    --profile)
      PROFILE="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

aws iam list-access-keys --profile "$PROFILE" --user-name "$USERNAME" --query 'AccessKeyMetadata[].[AccessKeyId,Status,CreateDate]' --output json | \
  jq -r '.[] | "\(.[0]) [\(.[1])] created: \(.[2] | split("T")[0])"'
