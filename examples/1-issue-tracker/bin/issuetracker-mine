#!/bin/bash
# Quick view of my Acme Jira issues
# Usage: issuetracker-mine [--all]


# Load credentials from environment or secure storage
load_credentials() {
    # Try environment variables first
    if [[ -n "$JIRA_API_TOKEN" ]]; then
        TOKEN="$JIRA_API_TOKEN"
        return 0
    fi

    # Try 1Password (if available)
    if command -v op &> /dev/null; then
        TOKEN=$(op read "op://Private/JIRA API/credential" 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    # Try Keybase (if available)
    if command -v keybase &> /dev/null; then
        TOKEN=$(keybase fs read /keybase/private/$(keybase whoami)/jira-token 2>/dev/null) || true
        if [[ -n "$TOKEN" ]]; then return 0; fi
    fi

    echo "Error: Credentials not found. Set JIRA_API_TOKEN environment variable." >&2
    exit 1
}

# Load credentials
load_credentials

set -euo pipefail


SHOW_ALL=false

if [ "${1:-}" = "--all" ]; then
  SHOW_ALL=true
fi

if [ "$SHOW_ALL" = true ]; then
  JQL='assignee = "user@example.com" ORDER BY updated DESC'
  echo "All issues assigned to me:"
else
  JQL='assignee = "user@example.com" AND status != Done ORDER BY updated DESC'
  echo "Open issues assigned to me:"
fi

echo ""

RESPONSE=$(curl --http1.1 -s -X POST \
  -H "Authorization: Basic $(echo -n "user@example.com:$TOKEN" | openssl base64 -A)" \
  -H "Content-Type: application/json" \
  --data "$(jq -n --arg jql "$JQL" '{jql: $jql, maxResults: 20, fields: ["summary", "status", "assignee", "updated"]}')" \
  "https://example.atlassian.net/rest/api/3/search/jql")

if echo "$RESPONSE" | jq -e '.errorMessages' >/dev/null 2>&1; then
  echo "Error: $(echo "$RESPONSE" | jq -r '.errorMessages | join(", ")')"
  exit 1
fi

COUNT=$(echo "$RESPONSE" | jq '.issues | length')

if [ "$COUNT" -eq 0 ]; then
  echo "No issues found."
  exit 0
fi

echo "Found $COUNT issue(s):"
echo ""

echo "$RESPONSE" | jq -r '.issues[] |
  "  \(.key): \(.fields.summary)\n" +
  "    Status: \(.fields.status.name) | Updated: \((.fields.updated // "Unknown") | tostring | split("T")[0])\n" +
  "    https://example.atlassian.net/browse/\(.key)\n"'
